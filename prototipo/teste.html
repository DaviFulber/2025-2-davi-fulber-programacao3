<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciador de Post-its (Tempor√°rio)</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f4f4f4;
      }

      /* √Årea onde os post-its aparecer√£o */
      #postItContainer {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
        margin-top: 20px;
      }

      /* ESTILO DO POST-IT DE SA√çDA */
      .post-it-item {
        width: 250px;
        min-height: 250px;
        padding: 15px;
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2);
        transform: rotate(calc(var(--rotation) * 1deg));
        border-radius: 5px;
        position: relative;
        transition: transform 0.2s;
      }

      .post-it-item:hover {
        z-index: 10;
        transform: scale(1.05) rotate(calc(var(--rotation) * 1deg));
      }

      .post-it-item h3 {
        font-size: 1.2em;
        margin-top: 0;
        margin-bottom: 5px;
        padding-bottom: 5px;
        /* Borda ser√° definida via JS/inline-style */
        word-wrap: break-word;
      }

      .post-it-item p {
        margin: 5px 0;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .post-it-item .post-it-data {
        font-size: 0.9em;
        font-weight: bold;
        margin-bottom: 10px;
        display: block;
      }

      /* Bot√£o de Excluir */
      .excluir-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        line-height: 1;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.8em;
        padding: 0;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .excluir-btn:hover {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <h1>üìã Meu Mural de Post-its</h1>
    <button onclick="alerta()">Adicionar Nova Anota√ß√£o</button>

    <div id="postItContainer"></div>

    <script>
    // Armazena todos os IDs de intervalo ativos para que possamos limp√°-los (parar o timer)
    const timersAtivos = {}; 

    // --- FUN√á√ïES AUXILIARES ---

    function getRandomRotation() {
        return Math.floor(Math.random() * 9) - 4;
    }

    function formatarData(data) {
        if (!data) return "";
        const [ano, mes, dia] = data.split("-");
        return `${dia}/${mes}/${ano}`;
    }

    // Fun√ß√£o que faz o c√°lculo e formata√ß√£o do tempo restante
    function calcularTempoRestante(dataAlvo) {
        const dataInformada = new Date(dataAlvo + 'T00:00:00').getTime(); // Assume meia-noite
        const dataAgora = new Date().getTime();
        let tempoFaltante = dataInformada - dataAgora;
        
        if (tempoFaltante < 0) {
            return {
                mensagem: "EXPIRADO!",
                expirado: true
            };
        }
        
        const msPorSegundo = 1000;
        const msPorMinuto = 60 * msPorSegundo;
        const msPorHora = 60 * msPorMinuto;
        const msPorDia = 24 * msPorHora;

        const dias = Math.floor(tempoFaltante / msPorDia);
        const horas = Math.floor((tempoFaltante % msPorDia) / msPorHora);
        const minutos = Math.floor((tempoFaltante % msPorHora) / msPorMinuto);
        const segundos = Math.floor((tempoFaltante % msPorMinuto) / msPorSegundo);

        return {
            mensagem: `Faltam: ${dias}d ${horas}h ${minutos}m ${segundos}s`,
            expirado: false
        };
    }

    // Fun√ß√£o que inicia e atualiza o timer
    function iniciarContagem(postItElement, data) {
        const postId = postItElement.getAttribute('data-post-id');
        
        // 1. Limpa o timer anterior se existir
        if (timersAtivos[postId]) {
            clearInterval(timersAtivos[postId]);
        }
        
        const timerElement = postItElement.querySelector('.post-it-timer');

        // 2. Fun√ß√£o de atualiza√ß√£o que ser√° chamada a cada segundo
        function atualizar() {
            const resultado = calcularTempoRestante(data);
            timerElement.textContent = resultado.mensagem;

            if (resultado.expirado) {
                clearInterval(timersAtivos[postId]); // Para o timer
                timerElement.style.color = 'red';
            } else {
                 timerElement.style.color = postItElement.style.color; // Mant√©m a cor do texto definida
            }
        }
        
        // Executa imediatamente para evitar atraso de 1s
        atualizar(); 
        
        // 3. Configura o novo intervalo e armazena o ID
        const intervalId = setInterval(atualizar, 1000);
        timersAtivos[postId] = intervalId;
    }

    // Fun√ß√£o para parar o timer (usada ao excluir o post-it)
    function pararContagem(postId) {
        if (timersAtivos[postId]) {
            clearInterval(timersAtivos[postId]);
            delete timersAtivos[postId];
        }
    }


    // --- FUN√á√ïES DE INTERFACE ---

    function alerta(postItElement = null) {
        let isEditing = postItElement !== null;
        let initialData = {};

        // Se estiver editando, extrai os dados atuais do Post-it
        if (isEditing) {
            const container = postItElement;
            const dataElement = container.querySelector(".post-it-data");
            const titleElement = container.querySelector("h3");
            const descElement = container.querySelector("p");

            const dataFormatada = dataElement.textContent.trim().split("/");
            const dataOriginal =
                dataFormatada.length === 3
                    ? `${dataFormatada[2]}-${dataFormatada[1]}-${dataFormatada[0]}`
                    : "";

            // Aten√ß√£o: Use getPropertyValue para cores em caso de valores computados/herdados
            // Por√©m, como estamos setando via JS, style.backgroundColor e style.color devem funcionar.
            initialData = {
                data: dataOriginal,
                titulo: titleElement.textContent.trim(),
                descricao: descElement.innerHTML.replace(/<br>/g, "\n").trim(),
                cor: container.style.backgroundColor || "#ffffa5", 
                corTxt: container.style.color || "#000000", 
            };
        } else {
            // Define valores padr√£o para um novo post-it
            initialData = {
                data: "",
                titulo: "",
                descricao: "",
                cor: "#ffffa5", 
                corTxt: "#000000", 
            };
        }

        Swal.fire({
            title: isEditing ? "Editar Anota√ß√£o" : "Nova Anota√ß√£o",
            customClass: {
                popup: "post-it-modal",
            },
            html: `
                <div class="post-it-form">
                    <label for="date">Data:</label>
                    <input id="date" type="date" class="swal2-input" value="${initialData.data}">

                    <label for="nome" style="margin-top: 10px; display: block;">T√≠tulo:</label>
                    <input id="nome" type="text" class="swal2-input" placeholder="T√≠tulo da tarefa" value="${initialData.titulo}">

                    <label for="descricao" style="margin-top: 10px; display: block;">Descri√ß√£o:</label>
                    <textarea id="descricao" class="swal2-textarea" placeholder="Detalhes e anota√ß√µes...">${initialData.descricao}</textarea>
                    
                    <label for="cor" style="margin-top: 10px; display: block;">Cor do Post-it:</label>
                    <input id="cor" type="color" class="swal2-input" value="${initialData.cor}" style="width: 50px; padding: 0; display: inline-block;">
                    
                    <label for="corTxt" style="margin-top: 10px; display: block;">Cor do Texto:</label>
                    <input id="corTxt" type="color" class="swal2-input" value="${initialData.corTxt}" style="width: 50px; padding: 0; display: inline-block;">
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: isEditing ? "Salvar Altera√ß√µes" : "Colar Post-it",
            cancelButtonText: "Cancelar",
            preConfirm: () => {
                const data = document.getElementById("date").value;
                const titulo = document.getElementById("nome").value;
                const descricao = document.getElementById("descricao").value;
                const cor = document.getElementById("cor").value;
                const corTxt = document.getElementById("corTxt").value;

                if (!data || !titulo || !descricao || !cor || !corTxt) {
                    Swal.showValidationMessage("Preencha todos os campos!");
                }

                return { data, titulo, descricao, cor, corTxt };
            },
        }).then((result) => {
            if (result.value) {
                adicionarOuAtualizarPostIt(
                    result.value.data,
                    result.value.titulo,
                    result.value.descricao,
                    result.value.cor,
                    result.value.corTxt,
                    postItElement
                );
            }
        });
    }

    function adicionarOuAtualizarPostIt(
        data,
        titulo,
        descricao,
        cor,
        textColor,
        postItElement
    ) {
        if (postItElement) {
            // --- L√ìGICA DE EDI√á√ÉO (ATUALIZA√á√ÉO) ---
            const container = postItElement;
            const postId = container.getAttribute('data-post-id');
            
            // 1. Aplica as cores e estilos
            container.style.background = cor;
            container.style.color = textColor;

            // 2. Atualiza os elementos internos
            container.querySelector(".post-it-data").textContent = formatarData(data);
            container.querySelector(".post-it-data").style.color = textColor;

            container.querySelector("h3").textContent = titulo;
            container.querySelector("h3").style.borderBottom = `2px solid ${textColor}`;

            container.querySelector("p").innerHTML = descricao.replace(/\n/g, "<br>");
            
            // 3. Reinicia o timer com a nova data
            iniciarContagem(container, data);

            Swal.fire("Atualizado!", "O post-it foi editado com sucesso.", "success");
            
        } else {
            // --- L√ìGICA DE ADI√á√ÉO (CRIA√á√ÉO) ---
            const container = document.getElementById("postItContainer");
            const rotation = getRandomRotation();
            const postId = Date.now().toString(); // ID √∫nico para o timer

            // 1. Cria o elemento div principal do post-it
            const postIt = document.createElement("div");
            postIt.classList.add("post-it-item");
            postIt.setAttribute('data-post-id', postId); // Armazena o ID
            postIt.style.setProperty("--rotation", rotation);

            // Aplica as cores
            postIt.style.background = cor;
            postIt.style.color = textColor;

            // Bot√£o de EXCLUIR
            const btnExcluir = document.createElement("button");
            btnExcluir.classList.add("excluir-btn");
            btnExcluir.textContent = "X";
            btnExcluir.onclick = function () {
                Swal.fire({
                    title: "Tem certeza?",
                    text: "Deseja remover esta anota√ß√£o?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Sim, remover!",
                    cancelButtonText: "Cancelar",
                }).then((confirm) => {
                    if (confirm.isConfirmed) {
                        pararContagem(postId); // Para o timer antes de remover
                        postIt.remove();
                        Swal.fire("Removido!", "O post-it foi retirado do mural.", "success");
                    }
                });
            };
            postIt.appendChild(btnExcluir);

            // Bot√£o de EDITAR
            const btnEditar = document.createElement("button");
            btnEditar.classList.add("excluir-btn"); 
            btnEditar.textContent = "‚öôÔ∏è"; 
            btnEditar.style.right = "30px"; 
            btnEditar.onclick = function () {
                alerta(postIt); 
            };
            postIt.appendChild(btnEditar);

            // 3. Adiciona o conte√∫do
            const htmlContent = `
                <span class="post-it-data" style="color: ${textColor};">${formatarData(data)}</span>
                <h3 style="border-bottom: 2px solid ${textColor};">${titulo}</h3>
                <p>${descricao.replace(/\n/g, "<br>")}</p>
                <div class="post-it-timer" style="font-weight: bold; margin-top: 10px;">Calculando...</div>
            `;

            postIt.insertAdjacentHTML("beforeend", htmlContent);

            // 4. Adiciona ao container
            container.appendChild(postIt);
            
            // 5. Inicia o timer para este novo post-it
            iniciarContagem(postIt, data);
        }
    }
</script>
  </body>
</html>
